name: Software Security Analysis CI

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # run every 6 hours
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  replace-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout teaching repo
      uses: actions/checkout@v3
      with:
        repository: 'SVF-tools/Software-Security-Analysis'
        path: 'teaching'

    - name: Checkout solutions repo (manual clone with token)
      run: |
        git clone https://yuleisui:${{ secrets.yulei_git_key }}@github.com/yuleisui/Software-Security-Analysis.git solutions

    - uses: actions/setup-node@v3
      with:
        node-version: 18

    # Setup for Ubuntu
    - name: ubuntu-setup
      run: |
        sudo apt-get update
        sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
        sudo apt-get update
        sudo apt-get install cmake gcc g++ nodejs doxygen graphviz lcov libncurses5-dev libtinfo6 libzstd-dev

    # Install SVF dependencies
    - name: env-setup
      run: |
        npm install svf-lib

    - name: Replace assignments with solutions
      run: |
        set -e  
        for i in {1..3}; do
          echo "Copying Assignment-$i..."
          if ! cp "solutions/Assignment-$i/Assignment-$i.cpp" "teaching/Assignment-$i/Assignment-$i.cpp"; then
            echo "Failed to copy Assignment-$i"
            exit 1
          fi
        done
        # Copy Lab-Exercise1 2 3
        cp -r solutions/Lab-Exercise-1/GraphAlgorithm.cpp teaching/Lab-Exercise-1/GraphAlgorithm.cpp
        cp -r solutions/Lab-Exercise-2/Z3Examples.cpp teaching/Lab-Exercise-2/Z3Examples.cpp
        cp -r solutions/Lab-Exercise-2/test.cpp teaching/Lab-Exercise-2/test.cpp
        cp -r solutions/Lab-Exercise-3/AEMgr.cpp teaching/Lab-Exercise-3/AEMgr.cpp
        


    - name: Build and Test
      working-directory: teaching
      run: |
        export SVF_DIR=$(npm root)/SVF
        export LLVM_DIR=$(npm root)/llvm-16.0.0.obj
        export Z3_DIR=$(npm root)/z3.obj
        echo "SVF_DIR="$SVF_DIR
        echo "LLVM_DIR="$LLVM_DIR
        echo "Z3_DIR="$Z3_DIR
        cmake .
        make
        ctest --output-on-failure
